{{> includes base="../" }}
<style>
    div.show {
        display:block;
    }
    .unauthenticated, .admin-panel, .only-started-quiz, .only-concluded-quiz, .only-no-quiz {
        display:none;
    }
    .timeout-display, .quiz-code-display {
        font-size:38px;
        font-weight:bold;
    }
    .winner-display {
        font-size:24px;
        font-weight:bold;
        margin-bottom:16px;
    }
</style>
<script>
    var wm, ws, question_id, contestants = {};

    function startQuiz() {
        ws.send("start", {});
    }

    function endQuiz() {
        ws.send("conclusion", {});
    }

    function nextQuestion() {
        ws.send("question", {});
    }

    function markResponseAsCorrect(response_id) {
        var payload = {};
        payload.response_id = response_id;
        payload.correct = true;
        ws.send("evaluate", payload);
    }

    function updatePlayers() {
        var names = [];
        for (var prop in contestants) if (contestants.hasOwnProperty(prop)) {
            names.push(contestants[prop].contestant_name);
        }

        $(".players-display").text(names.join(", "));
    }

    function zeroPrefix(s, n, c) {
        s = s.toString();
        c = c || '0';
        return (new Array(n - s.length + 1)).join(c) + s;
    }

    $(function () {
    Require(["assets/js/tblib/loader.js",
             "assets/js/tblib/ui.js",
             "assets/js/jswm2.js"], function () {

        ws = new WSManager("webdrawquiz.host_sid");
        ws.open("../api/v1/ws/host");

        $(window).on("beforeunload", function () { ws.close(); });

        loader.addTask(function (resolve) {
            if (ws.authenticated) resolve();
            else ws.on("authenticated", function () { resolve(); });
        }, 2000, "websocket");

        ws.on("message-type.start", function (e, msg) {
            if (!msg.title) {
                return reportError("Got unexpected response from server (type='start')");
            }
            $(".quiz-title").text(msg.title);
            $(".only-no-quiz").removeClass("show");
            $(".only-started-quiz").addClass("show");
        });

        ws.on("message-type.question", function (e, msg) {
            if (!msg.question || !msg.question_id || !msg.answer) {
                return reportError("Got unexpected response from server (type='question')");
            }
            question_id = msg.question_id;
            $(".quiz-question-display").text(msg.question);
            $(".quiz-answer-display").text(msg.answer);

            var expiry = new Date(msg.timeout).getTime();
            var interval = setInterval(function () {
                var timeRemaining = Math.max(expiry - new Date().getTime(), 0);
                var minutes = Math.floor(timeRemaining / (1000 * 60));
                var seconds = (timeRemaining / 1000) % 60;
                $(".timeout-display").text(
                        zeroPrefix(minutes, 2) +
                        ":" +
                        zeroPrefix(seconds.toFixed(2), 5));

                if (timeRemaining === 0)
                    clearInterval(interval);
            }, 1);
        });

        ws.on("message-type.contestant", function (e, msg) {
            if (msg.status == "connected") {
                contestants[msg.contestant_id] = msg;
            } else if (msg.status == "disconnected") {
                if (contestants[msg.contestant_id] !== undefined)
                    delete contestants[msg.contestant_id];
            } else {
                reportError("Got unexpected response from server (type='contestant').");
            }

            updatePlayers();
        });

        ws.on("message-type.conclusion", function (e, msg) {
            if (!msg.winner_id)
                return reportError("Got unexpected response from server (type='conclusion')");

            $(".only-started-quiz").removeClass("show");
            $(".only-concluded-quiz").addClass("show");
            var contestant = contestants[msg.winner_id];
            if (contestant === undefined)
                return reportError("Winning contestant is invalid or offline.");

            $(".winner-display").text(contestant.name);
        });

        loader.start();

        $(document).on("pageload", function () {
            wm = new JSWM($("body")[0]);

            $(".only-no-quiz").addClass("show");

            if (ws.authenticated) {
                $(".admin-panel").addClass("show");
                $(".quiz-code-display").text(
                        readCookie("webdrawquiz.quiz_code")
                );
            } else {
                $(".unauthenticated").addClass("show");
            }


            $(".start-quiz").click(function () { startQuiz(); });
            $(".end-quiz").click(function () { endQuiz(); });
            $(".next-question").click(function () { nextQuestion(); });

        });
    });
    });
</script>
{{> header }}
<main>
    <div class="hero-container">
        <h2>Administrate Quiz</h2>
        <h3 class="quiz-title"></h3>
    </div>
    <div class="unauthenticated">
        <p>
            Create a quiz here:
        </p>
        <div class="control-row">
            <a href="create"><button class="major">Create Quiz</button></a>
        </div>
    </div>
    <div class="admin-panel">
        <div class="only-no-quiz">
            <div class="control-row">
                <button class="major start-quiz">Start Quiz</button>
            </div>
        </div>
        <div class="control-row">
            <p>
                Quiz code:
            </p>
            <span class="quiz-code-display"></span>
        </div>
        <div class="control-row">
            <div>
                Players:
            </div>
            <span class="players-display"></span>
        </div>
        <div class="only-started-quiz">
            <div class="control-row">
                <button class="major next-question">Next Question</button>
                <button class="end-quiz">End Quiz</button>
            </div>
            <div class="control-row">
                <h3><q class="quiz-question-display"></q></h3>
                <h3 class="quiz-answer-display"></h3>
            </div>
            <div class="control-row">
                <div>
                    Time remaining:
                </div>
                <span class="timeout-display"></span>
            </div>
            <table class="main quiz-responses">
                <thead>
                    <tr>
                        <th>Contestant</th>
                        <th>Response</th>
                        <th><i class="material-icons">check</i></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>

                    </tr>
                </tbody>
            </table>
        </div>
        <div class="only-concluded-quiz">
            <p>
                The quiz is over. The winner is:
            </p>
            <span class="winner-display"></span>
        </div>
    </div>
</main>
<div class="overlay-container">
    <div class="error">

    </div>
</div>
